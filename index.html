<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>×××™×¨ ×ª××¨×™×š ×¢×‘×¨×™ ×œ×œ×•×¢×–×™</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      direction: rtl;
      background: linear-gradient(135deg, #667eea, #764ba2);
      min-height: 100vh;
      margin: 0;
      padding: 40px 20px;
      color: #fff;
      display: flex;
      justify-content: center;
    }

    .container {
      background: #fff;
      color: #333;
      max-width: 480px;
      width: 100%;
      border-radius: 12px;
      padding: 30px 25px;
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 700;
      color: #4b3ca7;
    }

    label {
      display: block;
      margin-top: 20px;
      font-weight: 600;
    }

    input[type="text"], select, input[type="number"] {
      margin-top: 8px;
      width: 100%;
      padding: 12px 15px;
      font-size: 16px;
      border-radius: 8px;
      border: 1.8px solid #ccc;
    }

    button {
      margin-top: 30px;
      width: 100%;
      background: #764ba2;
      color: white;
      font-weight: 700;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
    }

    button:hover {
      background: #5c3a90;
    }

    #preview {
      margin-top: 30px;
      background: #f0f0ff;
      padding: 15px 20px;
      border-radius: 10px;
      color: #333;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    #datesList {
      list-style: none;
      padding: 0;
      margin: 0 0 15px 0;
      max-height: 180px;
      overflow-y: auto;
    }

    #datesList li {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
    }

    #downloadLink {
      display: inline-block;
      background: #4b3ca7;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
    }

    * {
      box-sizing: border-box;
    }

  </style>
</head>
<body>
<div class="container">
  <h2>ğŸ“… ×”×•×¡×¤×ª ××™×¨×•×¢ ×œ×™×•××Ÿ</h2>
  <form id="eventForm">
    <label>×ª××¨×™×š ×¢×‘×¨×™</label>
    <div style="display: flex; gap: 10px;">
      <select id="hebrewDay" required>
        <option value="1">××³</option>
        <option value="2">×‘×³</option>
        <option value="3">×’×³</option>
        <option value="4">×“×³</option>
        <option value="5">×”×³</option>
        <option value="6">×•×³</option>
        <option value="7">×–×³</option>
        <option value="8">×—×³</option>
        <option value="9">×˜×³</option>
        <option value="10">×™×³</option>
        <option value="11">×™×´×</option>
        <option value="12">×™×´×‘</option>
        <option value="13">×™×´×’</option>
        <option value="14">×™×´×“</option>
        <option value="15">×˜×´×•</option>
        <option value="16">×˜×´×–</option>
        <option value="17">×™×´×–</option>
        <option value="18">×™×´×—</option>
        <option value="19">×™×´×˜</option>
        <option value="20">×›×³</option>
        <option value="21">×›×´×</option>
        <option value="22">×›×´×‘</option>
        <option value="23">×›×´×’</option>
        <option value="24">×›×´×“</option>
        <option value="25">×›×´×”</option>
        <option value="26">×›×´×•</option>
        <option value="27">×›×´×–</option>
        <option value="28">×›×´×—</option>
        <option value="29">×›×´×˜</option>
        <option value="30">×œ×³</option>
      </select>

      <select id="hebrewMonth" required>
        <option value="×ª×©×¨×™">×ª×©×¨×™</option>
        <option value="×—×©×•×•×Ÿ">×—×©×•×•×Ÿ</option>
        <option value="×›×¡×œ×•">×›×¡×œ×•</option>
        <option value="×˜×‘×ª" selected>×˜×‘×ª</option>
        <option value="×©×‘×˜">×©×‘×˜</option>
        <option value="××“×¨">××“×¨</option>
        <option value="××“×¨ ×‘">××“×¨ ×‘×³</option>
        <option value="× ×™×¡×Ÿ">× ×™×¡×Ÿ</option>
        <option value="××™×™×¨">××™×™×¨</option>
        <option value="×¡×™×•×Ÿ">×¡×™×•×Ÿ</option>
        <option value="×ª××•×–">×ª××•×–</option>
        <option value="××‘">××‘</option>
        <option value="××œ×•×œ">××œ×•×œ</option>
      </select>
    </div>

    <label for="eventName">×©× ×”××™×¨×•×¢</label>

    <input type="text" id="eventName" value="×™×•× ×”×•×œ×“×ª ×œ×œ×™×˜×œ" required/>

    <label for="eventType">×¡×•×’ ×”××™×¨×•×¢</label>
    <select id="eventType">
      <option value="birthday" selected>×™×•× ×”×•×œ×“×ª ğŸ‚</option>
      <option value="weddingAnniversary">×™×•× × ×™×©×•××™×Ÿ ğŸ‘©â€â¤ï¸â€ğŸ‘¨</option>
      <option value="yahrzeit">××–×›×¨×”ğŸ•¯</option>
      <option value="custom">××—×¨</option>
    </select>

    <label for="yearsAhead">×©× ×™× ×§×“×™××”</label>
    <input
      type="number"
      id="yearsAhead"
      value="5"
      min="0"
      max="200"
      step="1"
      oninput="validateYears(this)"
      required
    />
    <label for="actionType">×‘×—×¨ ×¤×¢×•×œ×”</label>
    <select id="actionType">
      <option value="add" selected>×”×•×¡×£ ××™×¨×•×¢</option>
      <option value="delete">××—×§ ××™×¨×•×¢</option>
    </select>


    <button type="submit">×”×•×¡×£ ××™×¨×•×¢</button>
  </form>
  <div id="actionStatus" style="margin-top: 15px; font-weight: bold; display: none;"></div>

  <div id="preview" style="display:none;">
    <h2>×ª×¦×•×’×” ××§×“×™××”:</h2>
    <ul id="datesList"></ul>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
  const CLIENT_ID = process.env.CLIENT_ID;
  const SCOPES = process.env.SCOPES;
  const CALENDAR_ID = process.env.CALENDAR_ID;

  let tokenClient;
  let accessToken;

  /* ---------- Init Google OAuth Client ---------- */
  window.onload = () => {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: '', // × ×©××¨ ×¨×™×§ ×›×™ × ×˜×¤×œ ×‘-requestAccessToken
    });
  };

  /* ---------- DOM Elements ---------- */
  const actionSelect = document.getElementById('actionType');
  const submitBtn = document.querySelector('button[type="submit"]');
  const statusDiv = document.getElementById('actionStatus');
  const list = document.getElementById('datesList');

  /* ---------- UI Handlers ---------- */
  actionSelect.addEventListener('change', () => {
    submitBtn.textContent = actionSelect.value === 'add' ? '×”×•×¡×£ ××™×¨×•×¢' : '××—×§ ××™×¨×•×¢';
  });

  /* ---------- Helpers ---------- */
  function validateYears(input) {
    if (input.value < 0) input.value = 0;
    if (input.value > 200) input.value = 200;
    input.value = Math.floor(input.value);
  }

  function getNextDate(dateStr) {
    const d = new Date(dateStr);
    d.setDate(d.getDate() + 1);
    return d.toISOString().split('T')[0];
  }

  function showStatus(message, color = 'black') {
    statusDiv.textContent = message;
    statusDiv.style.color = color;
    statusDiv.style.display = 'block';
    if (color === 'green') {
      setTimeout(() => statusDiv.style.display = 'none', 5000);
    }
  }

  /* ---------- OAuth ---------- */
  function requestAccessToken() {
    return new Promise((resolve, reject) => {
      tokenClient.callback = (tokenResponse) => {
        if (tokenResponse.error) {
          reject(tokenResponse);
        } else {
          accessToken = tokenResponse.access_token;
          resolve(accessToken);
        }
      };
      tokenClient.requestAccessToken();
    });
  }

  /* ---------- Calendar API ---------- */
  async function findEvent(summary, date) {
    if (!accessToken) await requestAccessToken();

    const timeMin = `${date}T00:00:00Z`;
    const timeMax = `${getNextDate(date)}T00:00:00Z`;

    const params = new URLSearchParams({
      timeMin,
      timeMax,
      q: summary,
      singleEvents: 'true',
    });

    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?${params.toString()}`;

    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${accessToken}` },
    });

    if (!res.ok) throw new Error('Failed to fetch events: ' + res.status);
    const data = await res.json();

    return data.items.filter(event => event.summary === summary);
  }

  async function addEventToCalendar(summary, date) {
    if (!accessToken) await requestAccessToken();

    const event = {
      summary,
      start: { date },
      end: { date: getNextDate(date) },
    };

    const res = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(event),
    });

    if (!res.ok) throw new Error('Failed to add event: ' + res.status);
    return await res.json();
  }

  async function addEventIfNotExists(summary, date) {
    try {
      const events = await findEvent(summary, date);
      if (events.length > 0) return '××™×¨×•×¢ ×§×™×™×';
      await addEventToCalendar(summary, date);
      return '× ×•×¡×£ ×‘×”×¦×œ×—×”!';
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  async function deleteEventIfExists(eventName, eventType, isoDate) {
    if (!accessToken) await requestAccessToken();

    const eventsToDelete = await findEvent(eventName, isoDate);
    if (eventsToDelete.length === 0) return '××™×¨×•×¢ ×œ× ×§×™×™×';

    const deleteUrl = `https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events/${eventsToDelete[0].id}`;
    const deleteRes = await fetch(deleteUrl, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${accessToken}` },
    });

    if (deleteRes.status === 204) return '× ××—×§ ×‘×”×¦×œ×—×”';
    else alert('×©×’×™××” ×‘××—×™×§×ª ×”××™×¨×•×¢');
  }

  /* ---------- Hebrew Date Conversion ---------- */
  const hebrewMonthMap = {
    '×ª×©×¨×™': 'tishrei',
    '×—×©×•×•×Ÿ': 'cheshvan',
    '×›×¡×œ×•': 'kislev',
    '×˜×‘×ª': 'tevet',
    '×©×‘×˜': 'shevat',
    '××“×¨': 'adar',
    '××“×¨ ×': 'adar1',
    '××“×¨ ×‘': 'adar2',
    '× ×™×¡×Ÿ': 'nisan',
    '××™×™×¨': 'iyyar',
    '×¡×™×•×Ÿ': 'sivan',
    '×ª××•×–': 'tammuz',
    '××‘': 'av',
    '××œ×•×œ': 'elul'
  };

  async function convertHebrewDateToGregorian(hy, hm, hd) {
    const url = `https://www.hebcal.com/converter?cfg=json&hy=${hy}&hm=${hm}&hd=${hd}&h2g=1&geo=il_telaviv`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('×©×’×™××” ×‘×”××¨×ª ×”×ª××¨×™×š');
    const data = await res.json();
    return { gy: data.gy, gm: data.gm, gd: data.gd };
  }

  /* ---------- Form Submission Handler ---------- */
  document.getElementById('eventForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const action = document.getElementById('actionType').value;
    showStatus(action === 'add' ? '××•×¡×™×£ ××™×¨×•×¢×™×...' : '××•×—×§ ××™×¨×•×¢×™×...', 'black');

    let yearsAhead = parseInt(document.getElementById('yearsAhead').value.trim(), 10);
    if (isNaN(yearsAhead) || yearsAhead < 0) yearsAhead = 0;
    else if (yearsAhead > 200) yearsAhead = 200;

    let eventName = document.getElementById('eventName').value.trim();
    const eventType = document.getElementById('eventType').value;

    switch (eventType) {
      case 'birthday': eventName += ' ğŸ‚'; break;
      case 'weddingAnniversary': eventName += ' ğŸ‘©â€â¤ï¸â€ğŸ‘¨'; break;
      case 'yahrzeit': eventName += ' ğŸ•¯'; break;
    }

    const day = document.getElementById('hebrewDay').value;
    const monthApi = hebrewMonthMap[document.getElementById('hebrewMonth').value];
    const year = 5785;

    if (!monthApi) {
      alert('×ª××¨×™×š ×¢×‘×¨×™ ×©×’×•×™');
      return;
    }

    list.innerHTML = '';
    document.querySelector("#preview h2").textContent = `×ª×¦×•×’×” ××§×“×™××”:`;
    document.getElementById('preview').style.display = 'block';

    for (let i = 0; i < yearsAhead; i++) {
      const hy = year + i;
      try {
        const { gy, gm, gd } = await convertHebrewDateToGregorian(hy, monthApi, day);
        const isoDate = `${gy}-${String(gm).padStart(2, '0')}-${String(gd).padStart(2, '0')}`;

        let res = '';
        if (action === 'add') {
          res = await addEventIfNotExists(eventName, isoDate);
        } else if (action === 'delete') {
          res = await deleteEventIfExists(eventName, eventType, isoDate);
        }

        const li = document.createElement('li');
        li.textContent = `${isoDate} - ${eventName} (${res})`;
        list.appendChild(li);

      } catch (err) {
        console.error(err);
        const li = document.createElement('li');
        li.textContent = `${hy}: ×©×’×™××” ×‘×”××¨×”`;
        list.appendChild(li);
      }
    }

    showStatus(action === 'add' ? '×”×•×¡×¤×ª ×”××™×¨×•×¢×™× ×”×•×©×œ××”!' : '××—×™×§×ª ×”××™×¨×•×¢×™× ×”×•×©×œ××”!', 'green');
  });

</script>
</body>
</html>
